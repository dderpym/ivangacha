"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib");require("reflect-metadata");var t=function(){function e(){}return e.getBaseClass=function(e){return e?Reflect.getPrototypeOf(e):void 0},e.getJsonPropertiesMetadata=function(t,r){if(t){var i=""+e.apiMap+(r||t.constructor.name);return Reflect.getMetadata(i,t)}},e.getParamTypes=function(t){return t?Reflect.getMetadata(e.designParamTypes,t):void 0},e.getJsonObjectMetadata=function(t){return t?Reflect.getMetadata(e.apiMapJsonObject,t):void 0},e.getType=function(t,r){return t?Reflect.getMetadata(e.designType,t,r):void 0},e.isJsonObject=function(t){return!!t&&Reflect.hasOwnMetadata(e.apiMapJsonObject,t)},e.setJsonPropertiesMetadata=function(t,r){if(r){var i=""+e.apiMap+r.constructor.name;Reflect.defineMetadata(i,t,r)}},e.setJsonObject=function(t,r){r&&Reflect.defineMetadata(e.apiMapJsonObject,t,r)},e.setType=function(t,r,i){r&&t&&Reflect.defineMetadata(e.designType,t,r,i)},e.apiMap="api:map:",e.apiMapJsonObject=e.apiMap+"jsonObject",e.designType="design:type",e.designParamTypes="design:paramtypes",e}(),r=function(e){return"string"==typeof e},i=function(e){return null!==e&&"object"==typeof e&&!n(e)},n=function(e){return Array.isArray(e)},o=function(e){return"[object Date]"===toString.call(e)},a=function(e){return[null,void 0].includes(e)},s=function(e){return t.isJsonObject(e)},l=function(e){try{var t=JSON.parse(e);return"object"==typeof t?t:e}catch(t){return e}},u=function(){this.errorCallback=c,this.nullishPolicy={undefined:"remove",null:"allow"}},c=function(e){console.error(e)},p=function(){function c(t){this.options=new u,this.options=e.__assign(e.__assign({},this.options),t)}return c.prototype.deserialize=function(e,t){return r(e)&&(e=l(e)),n(e)?this.deserializeObjectArray(e,t):i(e)?this.deserializeObject(e,t):void this.error("Fail to deserialize: value is not an Array nor an Object.\nReceived: "+JSON.stringify(e)+".")},c.prototype.deserializeObject=function(e,t){var n=this;if(null===e)return"disallow"===this.options.nullishPolicy.null&&this.error("Fail to deserialize: null is not assignable to type Object."),null;if(void 0!==e){if(r(e)&&(e=l(e)),i(e)){var o=function(e){if("function"!=typeof e)return!1;try{Reflect.construct(String,[],e)}catch(e){return!1}return!0}(t)?new t({}):t,s=this.getJsonPropertiesMetadata(o);return s?(Object.keys(s).forEach((function(t){var r=s[t],i=n.deserializeProperty(o,t,e,r);if(r.required&&a(i)){var l=o.constructor.name;n.error("Property '"+t+"' is required in "+l+" "+JSON.stringify(e)+".")}n.isAllowedProperty(i)&&(o[t]=i)})),o):o}this.error("Fail to deserialize: type '"+typeof e+"' is not assignable to type 'Object'.\nReceived: "+JSON.stringify(e))}else"disallow"===this.options.nullishPolicy.undefined&&this.error("Fail to deserialize: undefined is not assignable to type Object.")},c.prototype.deserializeObjectArray=function(e,t){var i=this;if(null===e)return"disallow"===this.options.nullishPolicy.null&&this.error("Fail to deserialize: null is not assignable to type Array."),null;if(void 0!==e){if(r(e)&&(e=l(e)),n(e))return e.reduce((function(e,r){var n=i.deserializeObject(r,t);return(!a(n)||null===n&&"remove"!==i.options.nullishPolicy.null||void 0===n&&"remove"!==i.options.nullishPolicy.undefined)&&e.push(n),e}),[]);this.error("Fail to deserialize: type '"+typeof e+"' is not assignable to type 'Array'.\nReceived: "+JSON.stringify(e))}else"disallow"===this.options.nullishPolicy.undefined&&this.error("Fail to deserialize: undefined is not assignable to type Array.")},c.prototype.serialize=function(e){return n(e)?this.serializeObjectArray(e):i(e)?this.serializeObject(e):void this.error("Fail to serialize: value is not an Array nor an Object.\nReceived: "+JSON.stringify(e)+".")},c.prototype.serializeObject=function(e){var t=this;if(null===e)return"disallow"===this.options.nullishPolicy.null&&this.error("Fail to serialize: null is not assignable to type Object."),null;if(void 0!==e){if(!i(e))return e;var r=this.getJsonPropertiesMetadata(e);if(!r)return e;var o={},a=Object.keys(e);return Object.keys(r).forEach((function(i){if(a.includes(i)){var s=r[i],l=void 0;s.beforeSerialize&&(l=e[i],e[i]=s.beforeSerialize(e[i],e));var u=t.serializeProperty(e,i,s);if(s.afterSerialize&&(u=s.afterSerialize(u,e)),e[i]=l||e[i],n(s.name))s.name.forEach((function(e){t.isAllowedProperty(u[e])&&(o[e]=u[e])}));else if(t.isAllowedProperty(u))if(s.isNameOverridden||void 0===t.options.formatPropertyName)o[s.name]=u;else{var c=t.options.formatPropertyName(s.name);o[c]=u}}else"remove"!==t.options.nullishPolicy.undefined&&(o[i]=void 0)})),o}"disallow"===this.options.nullishPolicy.undefined&&this.error("Fail to serialize: undefined is not assignable to type Object.")},c.prototype.serializeObjectArray=function(e){var t=this;if(null===e)return"disallow"===this.options.nullishPolicy.null&&this.error("Fail to serialize: null is not assignable to type Array."),null;if(void 0!==e){if(n(e))return e.reduce((function(e,r){var i=t.serializeObject(r);return(!a(i)||null===i&&"remove"!==t.options.nullishPolicy.null||void 0===i&&"remove"!==t.options.nullishPolicy.undefined)&&e.push(i),e}),[]);this.error("Fail to serialize: type '"+typeof e+"' is not assignable to type 'Array'.\nReceived: "+JSON.stringify(e)+".")}else"disallow"===this.options.nullishPolicy.undefined&&this.error("Fail to serialize: undefined is not assignable to type Array.")},c.prototype.deserializeProperty=function(e,r,i,n){var o;if(!a(i)){var l=this.getDataSource(i,n,this.options.formatPropertyName);if(a(l))return l;var u,c=t.getType(e,r),p="array"===(null===(o=null==c?void 0:c.name)||void 0===o?void 0:o.toLowerCase()),f=n.type||c;n.beforeDeserialize&&(l=n.beforeDeserialize(l,e));var d=n.predicate;return n.isDictionary?u=this.deserializeDictionary(l,f,d):p?u=this.deserializeArray(l,f,d):!s(f)&&!d||d&&!d(l,i)?u=this.deserializePrimitive(l,f.name):(f=n.predicate?n.predicate(l,i):f,u=this.deserializeObject(l,f)),n.afterDeserialize&&(u=n.afterDeserialize(u,e)),u}},c.prototype.deserializePrimitive=function(e,t){if(a(t))return e;if(typeof e===(t=t.toLowerCase()))return e;var r="Fail to deserialize: type '"+typeof e+"' is not assignable to type '"+t+"'.\nReceived: "+JSON.stringify(e);switch(t){case"string":var i=e.toString();return"[object Object]"===i?void this.error(r):i;case"number":return function(e){return"number"==typeof e}(e)?+e:void this.error(r);case"boolean":return void this.error(r);case"date":return function(e){return!o(e)&&!n(e)&&!isNaN(Date.parse(e))}(e)?new Date(e):void this.error(r);default:return e}},c.prototype.deserializeDictionary=function(e,t,r){var n=this;if(i(e)){var o={};return Object.keys(e).forEach((function(i){var a=r?r(e[i],e):void 0;s(t)||a?o[i]=n.deserializeObject(e[i],a||t):o[i]=n.deserializePrimitive(e[i],typeof e[i])})),o}this.error("Fail to deserialize: type '"+typeof e+"' is not assignable to type 'Dictionary'.\nReceived: "+JSON.stringify(e)+".")},c.prototype.deserializeArray=function(e,t,r){var i=this;if(n(e))return e.reduce((function(n,o){var l;return s(t)||r?(t=r?r(o,e):t,l=i.deserializeObject(o,t)):l=i.deserializePrimitive(o,typeof o),(!a(l)||null===l&&"remove"!==i.options.nullishPolicy.null||void 0===l&&"remove"!==i.options.nullishPolicy.undefined)&&n.push(l),n}),[]);this.error("Fail to deserialize: type '"+typeof e+"' is not assignable to type 'Array'.\nReceived: "+JSON.stringify(e))},c.prototype.error=function(e){this.options.errorCallback&&this.options.errorCallback(e)},c.prototype.getClassesJsonPropertiesMetadata=function(e,r){return e?e.reduce((function(e,i){var n=t.getJsonPropertiesMetadata(r,i);return n&&e.push(n),e}),[]):[]},c.prototype.getDataSource=function(e,t,r){var i=t.name,o=t.isNameOverridden;if(n(i)){var a={};return i.forEach((function(t){return a[t]=e[t]})),a}return!o&&r?(i=r(i),e[i]):e[i]},c.prototype.getJsonPropertiesMetadata=function(r){var i,n=(null!==(i=t.getJsonObjectMetadata(r.constructor))&&void 0!==i?i:{}).baseClassNames,o=t.getJsonPropertiesMetadata(r);if(!(o||n&&n.length))return o;if(n&&n.length){var a=this.getClassesJsonPropertiesMetadata(n,r);return this.mergeJsonPropertiesMetadata.apply(this,e.__spreadArray(e.__spreadArray([],a),[o]))}return o},c.prototype.isAllowedProperty=function(e){if(a(e)){if("disallow"===this.options.nullishPolicy[""+e])return this.error("Disallowed "+e+" value detected."),!1;if("remove"===this.options.nullishPolicy[""+e])return!1}return!0},c.prototype.mergeJsonPropertiesMetadata=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var i={};return t.forEach((function(t){t&&Object.keys(t).forEach((function(r){i[r]=e.__assign(e.__assign({},i[r]),t[r])}))})),i},c.prototype.serializeDictionary=function(e){var t=this;if(i(e)){var r={};return Object.keys(e).forEach((function(i){r[i]=t.serializeObject(e[i])})),r}this.error("Fail to serialize: type '"+typeof e+"' is not assignable to type 'Dictionary'.\nReceived: "+JSON.stringify(e)+".")},c.prototype.serializeProperty=function(e,r,i){var n,a,l=e[r],u=t.getType(e,r),c="array"===(null===(n=null==u?void 0:u.name)||void 0===n?void 0:n.toLocaleLowerCase()),p=i.predicate,f=i.type||u,d=s(f);return l&&(d||p)?c?this.serializeObjectArray(l):i.isDictionary?this.serializeDictionary(l):this.serializeObject(l):"date"===(null===(a=null==f?void 0:f.name)||void 0===a?void 0:a.toLocaleLowerCase())&&o(l)?l.toISOString():l},c}(),f=function(r){var i=t.getBaseClass(r);return i&&i.name?e.__spreadArray(e.__spreadArray([],f(i)),[i.name]):[]},d=function(e){var t,r=e.toString().split("}")[0].replace(/(\/\*[\s\S]*?\*\/|\/\/.*$)/gm,"").replace(/[\r\t\n\v\f ]/g,""),i=r.length;","===r[i-2]&&(t=r[i-1]);var n=t?new RegExp("(?:(this|"+t+"|\\("+t+"=t.call\\(this(,.)*\\)\\))\\.)([^,;\n}]+)","gm"):new RegExp("(?:(this)\\.)([^,;\n}]+)","gm"),o=new Map,a=/(?:.*(?:constructor|function).*?(?=\())(?:\()(.+?(?=\)))/m.exec(r);if(!a||!a.length)return o;for(var s,l=a[1].split(","),u=function(){var e=s.length-1,t=s[e].split("="),r=l.findIndex((function(e){return e===t[1]}));r>-1&&o.set(r,t[0])};s=n.exec(r);)u();return o},y=function(n,o){var a={name:n.toString()};return o?r(o)?(a.name=o,a.isNameOverridden=!0,a):(i(o)&&(a=e.__assign(e.__assign({},a),o),o.name&&(a.name=o.name,a.isNameOverridden=!0),function(e){if(!e)return!1;var r=t.getParamTypes(e),i=e.length;return(1===i||2===i)&&!r}(o.type)&&(delete a.type,a.predicate=o.type)),a):a};exports.JsonObject=function(){return function(e){var r=f(e);t.setJsonObject({baseClassNames:r},e)}},exports.JsonProperty=function(e){return function(r,i,n){var o;if(void 0===i&&r.prototype){var a=t.getParamTypes(r)[n];i=d(r.prototype.constructor).get(n),r=r.prototype,t.setType(a,r,i)}var s=null!==(o=t.getJsonPropertiesMetadata(r))&&void 0!==o?o:{};s[i]=y(i,e),t.setJsonPropertiesMetadata(s,r)}},exports.JsonSerializer=p,exports.JsonSerializerOptions=u,exports.isNullish=a,exports.logError=c,exports.throwError=function(e){throw new Error(e)};
